---
- name: Install k3s
  hosts: raspberry_pis
  become: true
  gather_facts: true
  vars:
    k3s_version: v1.32.3+k3s1
    kubeconfig_path: /Users/brandonapol/Documents/code/birchwood-infra/ansible/k3s.yaml
    k3s_token_path: /var/lib/rancher/k3s/server/node-token
    ca_dir: /etc/rancher/k3s/certs
    ca_cert_path: "{{ ca_dir }}/ca.crt"
    k3s_server_cert_path: "{{ ca_dir }}/server.crt"
    k3s_server_key_path: "{{ ca_dir }}/server.key"
    k3s_client_cert_path: "{{ ca_dir }}/client.crt"
    k3s_client_key_path: "{{ ca_dir }}/client.key"

  tasks:
    - name: Create k3s directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      with_items:
        - /var/lib/rancher/k3s/server
        - /etc/rancher/k3s
        - "{{ ca_dir }}"

    - name: Download k3s installation script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: "0755"

    - name: Generate random token for k3s
      shell: openssl rand -hex 32
      register: k3s_token
      when: inventory_hostname == 'hostname0'

    - name: Create token file on control node
      copy:
        content: "{{ k3s_token.stdout }}"
        dest: "{{ k3s_token_path }}"
        mode: "0600"
      when: inventory_hostname == 'hostname0'

    - name: Install k3s on control node (hostname0)
      shell: |
        /tmp/k3s-install.sh server \
          --token-file {{ k3s_token_path }} \
          --tls-san {{ hostvars['hostname0']['ansible_host'] }} \
          --tls-san hostname0 \
          --node-label "node-role=control-plane" \
          --write-kubeconfig-mode 644 \
          --disable servicelb
      when: inventory_hostname == 'hostname0'
      register: k3s_install
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for control node to be ready
      shell: kubectl get nodes
      register: k3s_status
      until: k3s_status.rc == 0
      retries: 30
      delay: 10
      when: inventory_hostname == 'hostname0'

    - name: Set k3s token for other nodes
      set_fact:
        k3s_token: "{{ hostvars['hostname0']['k3s_token'].stdout }}"
      when: inventory_hostname != 'hostname0'

    - name: Create token file on worker nodes
      copy:
        content: "{{ k3s_token }}"
        dest: "{{ k3s_token_path }}"
        mode: "0600"
      when: inventory_hostname != 'hostname0'

    - name: Install k3s on worker nodes
      shell: |
        /tmp/k3s-install.sh agent \
          --server https://{{ hostvars['hostname0']['ansible_host'] }}:6443 \
          --token-file {{ k3s_token_path }} \
          --node-label "node-role=worker" \
          --node-name {{ inventory_hostname }}
      when: inventory_hostname != 'hostname0'
      register: k3s_install
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for worker nodes to join cluster
      shell: kubectl get nodes
      register: k3s_status
      until: k3s_status.rc == 0 and inventory_hostname in k3s_status.stdout
      retries: 30
      delay: 10
      when: inventory_hostname == 'hostname0'

    - name: Wait for Traefik to be ready
      shell: kubectl get pods -n kube-system -l app.kubernetes.io/name=traefik
      register: traefik_status
      until: traefik_status.rc == 0 and "Running" in traefik_status.stdout
      retries: 30
      delay: 10
      when: inventory_hostname == 'hostname0'

    - name: Fetch kubeconfig from control node
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ kubeconfig_path }}"
        flat: yes
      when: inventory_hostname == 'hostname0'

    - name: Display setup instructions
      debug:
        msg: |
          K3s installation completed!

          To use kubectl from your MacBook:
          1. Copy the kubeconfig file:
             scp {{ kubeconfig_path }} ~/.kube/config
          2. Update the server address in the kubeconfig to use hostname0's IP:
             sed -i '' 's/127.0.0.1/{{ hostvars['hostname0']['ansible_host'] }}/' ~/.kube/config
          3. Test the connection:
             kubectl get nodes
             kubectl get pods -n kube-system
      when: inventory_hostname == 'hostname0'
